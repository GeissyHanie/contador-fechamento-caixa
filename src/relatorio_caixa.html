<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fechamento Detalhado | Candy Store Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="relatorio_caixa.css">
</head>
<body class="relatorio-body">

    <nav class="navbar">
        <div class="nav-container">
            <div class="brand">üè© Doces e Mimos</div>
            <div class="menu-central">
                <span onclick="window.location.href='dashboard.html'" style="cursor: pointer;">Dashboard</span>
                <span class="active">Relat√≥rios</span>
                <span onclick="window.location.href='caixa.html'" style="cursor: pointer;">Caixa</span>
            </div>
            <div class="nav-btns">
                <button class="btn-pdf" onclick="gerarPDF()">üìÑ Exportar PDF</button>
                <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimir</button>
            </div>
        </div>
    </nav>

    <main class="main-container">
        <header class="header-relatorio">
            <div class="titulo-grupo">
                <span class="tag">üìä RELAT√ìRIO FINANCEIRO</span>
                <h1>Fechamento de Caixa</h1>
                <p>Confira os valores e movimenta√ß√µes do turno para valida√ß√£o da ger√™ncia.</p>
            </div>
            <div class="info-turno">
                <p><strong>DATA E HORA:</strong> <span id="rel-data-hora">--/--/---- - --:--</span></p>
                <p><strong>OPERADOR:</strong> üìç <span id="rel-operador">Nome do Usu√°rio</span></p>
                <p><strong>ID TURNO:</strong> <span id="rel-id-turno">#TRN-00000</span></p>
            </div>
        </header>

        <section class="cards-resumo">
            <div class="card-resumo azul">
                <span>SALDO INICIAL</span>
                <h2 id="resumo-inicial">R$ 200,00</h2>
                <p>‚úì Fundo de troco padr√£o</p>
            </div>
            <div class="card-resumo rosa">
                <span>TOTAL SANGRIAS</span>
                <h2 id="resumo-sangria">R$ 0,00</h2>
                <p>‚Üì Retiradas do caixa</p>
            </div>
            <div class="card-resumo verde">
                <span>TOTAL CONTADO</span>
                <h2 id="resumo-final">R$ 0,00</h2>
                <p id="resumo-liquido">üìà L√≠quido: R$ 0,00</p>
            </div>
        </section>

        <div class="grid-conteudo">
            <section class="painel-branco">
                <h3>üèß Detalhamento da Contagem</h3>
                <table class="tabela-contagem">
                    <thead>
                        <tr><th>DENOMINA√á√ÉO</th><th>QTD.</th><th>SUBTOTAL</th></tr>
                    </thead>
                    <tbody id="tabela-corpo">
                    </tbody>
                    <tfoot>
                        <tr class="total-destaque">
                            <td colspan="2">TOTAL CONTADO</td>
                            <td id="total-contado-tabela">R$ 0,00</td>
                        </tr>
                    </tfoot>
                </table>
            </section>

            <div class="coluna-apoio">
                <section class="painel-branco">
                    <h3 class="titulo-sangria">üí∏ Sangrias (Retiradas)</h3>
                    <div id="lista-sangrias">
                        <p style="color: #666; font-style: italic;">Nenhuma sangria registrada neste turno.</p>
                    </div>
                </section>

                <section class="painel-branco validacao">
                    <h3>üîê Espa√ßo da Ger√™ncia</h3>
                    <label class="check-box">
                        <input type="checkbox" id="conferido-fisico">
                        O valor f√≠sico confere com o sistema?
                    </label>
                    <div class="campo-obs">
                        <label>Observa√ß√£o da Ger√™ncia:</label>
                        <textarea id="obs-gerencia" placeholder="Digite aqui os detalhes..."></textarea>
                    </div>
                    <div class="campo-obs">
                        <label>Respons√°vel:</label>
                        <select id="quem-validou">
                            <option value="">Selecione...</option>
                            <option value="Geissy">Geissy</option>
                            <option value="Gezilene">Gezilene</option>
                        </select>
                    </div>
                    <div id="assinatura-impressao" style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px;">
                        <p style="font-size: 14px; margin-bottom: 5px;"><strong>RELAT√ìRIO DE FECHAMENTO CONFERIDO</strong></p>
                        <p id="texto-validacao-pdf" style="font-size: 16px; color: #333;">Aguardando valida√ß√£o...</p>
                    </div>
                    <button class="btn-finalizar" onclick="validarEEncerrar()">Validar e Encerrar Turno</button>
                </section>
            </div>
        </div>
    </main>

    <script>
    window.onload = function() {
        try {
            // 1. Recuperar dados
            const dados = JSON.parse(localStorage.getItem('dadosContagem')) || {};
            const usuario = localStorage.getItem('usuarioLogado') || "N√£o identificado";
            const SALDO_INICIAL = 200.00;

            // 2. Tratar Sangria
            const sangriaTexto = localStorage.getItem('totalUltimaSangria') || "R$ 0,00";
            const valorSangriaNum = parseFloat(sangriaTexto.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;

            // 3. Atualizar Cabe√ßalho
            const agora = new Date();
            const elData = document.getElementById('rel-data-hora');
            const elOperador = document.getElementById('rel-operador');
            const elIdTurno = document.getElementById('rel-id-turno');

            if(elData) elData.innerText = agora.toLocaleDateString('pt-BR') + " - " + agora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            if(elOperador) elOperador.innerText = usuario;
            if(elIdTurno) elIdTurno.innerText = "#TRN-" + Math.floor(10000 + Math.random() * 90000);

            // 4. Tabela de Contagem
            const corpoTabela = document.getElementById('tabela-corpo');
            let totalNotasMoedas = 0; // Soma bruta de todas as notas e moedas contadas
            
            const denominacoes = [
                { label: "üíµ Notas R$ 200", valor: 200 }, { label: "üíµ Notas R$ 100", valor: 100 },
                { label: "üíµ Notas R$ 50", valor: 50 }, { label: "üíµ Notas R$ 20", valor: 20 },
                { label: "üíµ Notas R$ 10", valor: 10 }, { label: "üíµ Notas R$ 5", valor: 5 },
                { label: "üíµ Notas R$ 2", valor: 2 }, { label: "üçä Moedas R$ 1,00", valor: 1 },
                { label: "üçä Moedas R$ 0,50", valor: 0.5 }, { label: "üçä Moedas R$ 0,25", valor: 0.25 },
                { label: "üçä Moedas R$ 0,10", valor: 0.1 }, { label: "üçä Moedas R$ 0,05", valor: 0.05 }
            ];

            if (corpoTabela) {
                corpoTabela.innerHTML = ""; 
                denominacoes.forEach(item => {
                    const qtd = dados[item.valor.toString()] || 0;
                    const subtotal = item.valor * qtd;
                    totalNotasMoedas += subtotal;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${item.label}</td><td>${qtd}</td><td>${subtotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>`;
                    corpoTabela.appendChild(tr);
                });
            }

            // 5. Atualizar Valores Financeiros
            const formatar = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            // C√ÅLCULO SOLICITADO: Total Contado agora √© Notas - Sangria
            const totalContadoComDesconto = totalNotasMoedas - valorSangriaNum;

            const elResSangria = document.getElementById('resumo-sangria');
            const elResFinal = document.getElementById('resumo-final');
            const elTotalTab = document.getElementById('total-contado-tabela');
            const elResLiq = document.getElementById('resumo-liquido');

            if(elResSangria) elResSangria.innerText = formatar(valorSangriaNum);
            
            // O card Verde agora mostra o valor descontado
            if(elResFinal) elResFinal.innerText = formatar(totalContadoComDesconto);
            
            // A tabela de contagem l√° embaixo ainda mostra o bruto das notas para confer√™ncia f√≠sica
            if(elTotalTab) elTotalTab.innerText = formatar(totalNotasMoedas);

            // C√°lculo do L√≠quido Real (Soma das Notas - Fundo Inicial - Sangria)
            const liquido = totalNotasMoedas - SALDO_INICIAL - valorSangriaNum;
            if(elResLiq) elResLiq.innerText = "üìà L√≠quido: " + formatar(liquido);

            // 6. Lista Lateral (Sangrias)
const listaS = document.getElementById('lista-sangrias');

// Buscamos a observa√ß√£o exata que salvamos na tela anterior
const obsSalva = localStorage.getItem('obsUltimaSangria');

if (listaS && valorSangriaNum > 0) {
    listaS.innerHTML = `
        <div style="background: #fff5f8; border-radius: 8px; border-left: 4px solid #ff33cc; padding: 12px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-weight: 600; color: #333;">Retirada Efetuada</span>
                <strong style="color: #e91e63;">- ${formatar(valorSangriaNum)}</strong>
            </div>
            <div style="font-size: 13px; color: #666; border-top: 1px solid #ffe0f0; padding-top: 8px; margin-top: 8px; line-height: 1.4;">
                <strong>Motivo/Obs:</strong><br>
                ${obsSalva ? obsSalva : "Nenhuma observa√ß√£o detalhada."}
            </div>
        </div>`;
} else if (listaS) {
    listaS.innerHTML = '<p style="color: #666; font-style: italic;">Nenhuma sangria registrada neste turno.</p>';
}

            // 7. Evento do Select
            const selectResp = document.getElementById('quem-validou');
            const txtVal = document.getElementById('texto-validacao-pdf');
            if (selectResp && txtVal) {
                selectResp.addEventListener('change', function() {
                    txtVal.innerHTML = this.value ? `Validado por: <strong>${this.value}</strong> em ${new Date().toLocaleDateString('pt-BR')}` : "Aguardando valida√ß√£o...";
                });
            }

        } catch (e) { console.error("Erro:", e); }
    };

    function validarEEncerrar() {
        const resp = document.getElementById('quem-validou').value;
        if (!resp) return alert("‚ö†Ô∏è Selecione o respons√°vel.");
        if (confirm("Deseja finalizar o turno?")) window.location.href = 'validacao_relatorio.html';
    }

    function gerarPDF() { window.print(); }
</script>
</body>
</html>