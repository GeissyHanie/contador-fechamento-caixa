<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fechamento Conclu√≠do | Doces e Mimos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="fechamento_concluido.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body class="concluido-body">

    <div class="main-container">
        <div class="success-icon-container">
            <div class="outer-circle">
                <div class="inner-circle">
                    <span class="check-mark">‚úì</span>
                </div>
            </div>
        </div>

        <main class="card-concluido">
            <div class="tag-sucesso">SUCESSO!</div>
            
            <h1 class="titulo-curvo">Fechamento Conclu√≠do!</h1>
            <p class="subtitulo">O caixa do dia foi encerrado com sucesso. Tudo est√° doce e em ordem!</p>

            <section class="resumo-final-box">
                <p class="resumo-label">RESUMO DO FECHAMENTO</p>
                
                <div class="row-stats">
                    <div class="stat-box">
                        <span class="stat-label">Saldo Final</span>
                        <strong class="text-green" id="saldo-final">R$ 0,00</strong>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Diferen√ßa</span>
                        <strong class="text-pink" id="diferenca-valor">R$ 0,00</strong>
                    </div>
                </div>

                <div class="info-rodape">
                    <div class="info-linha">
                        <span>Respons√°vel:</span>
                        <strong id="nome-responsavel">Maria Silva</strong>
                    </div>
                    <div class="info-linha">
                        <span>Data/Hora:</span>
                        <strong id="data-hora-texto">24/10/2023 - 18:45</strong>
                    </div>
                </div>
            </section>

            <div class="botoes-acao">
                <button class="btn-relatorio-branco" onclick="window.location.href='relatorio_caixa.html'">üìÑ Ver Relat√≥rio</button>
                <button class="btn-inicio" onclick="voltarAoInicio()">
                    <span class="icon">‚äû</span> Voltar ao In√≠cio
                </button>
            </div>
        </main>
    </div>

    <script>
    function voltarAoInicio() {
        // Limpa os dados de contagem e sangria para o pr√≥ximo turno
        localStorage.removeItem('dadosContagem');
        localStorage.removeItem('totalUltimaSangria'); 
        window.location.href = 'dashboard.html';
    }

    window.onload = function() {
        // 1. Recupera os dados
        const dados = JSON.parse(localStorage.getItem('dadosContagem')) || {};
        const usuarioLogado = localStorage.getItem('usuarioLogado');
        const SALDO_ESPERADO = 1248.50; // Ajuste este valor conforme sua necessidade de confer√™ncia

        // 2. Recupera a sangria (se houver) e converte para n√∫mero
        const sangriaTexto = localStorage.getItem('totalUltimaSangria') || "R$ 0,00";
        const valorSangriaNum = parseFloat(sangriaTexto.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;

        // 3. Calcula o Total F√≠sico Contado
        let totalContado = 0;
        for (const valor in dados) {
            totalContado += parseFloat(valor) * dados[valor];
        }

        // 4. L√ìGICA PRINCIPAL: Saldo Final = Total Contado - Sangria
        const saldoFinal = totalContado - valorSangriaNum;

        // 5. Calcula a diferen√ßa em rela√ß√£o ao esperado (opcional)
        const diferenca = saldoFinal - SALDO_ESPERADO;

        // Atualiza Saldo Final na tela
        document.getElementById('saldo-final').innerText = saldoFinal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        // Atualiza Diferen√ßa na tela
        const displayDiff = document.getElementById('diferenca-valor');
        const sinal = diferenca > 0 ? "+ " : (diferenca < 0 ? "- " : "");
        displayDiff.innerText = sinal + Math.abs(diferenca).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        displayDiff.style.color = diferenca >= 0 ? "#2ecc71" : "#e91e63";

        // Atualiza Nome do Respons√°vel
        if (usuarioLogado) {
            document.getElementById('nome-responsavel').innerText = usuarioLogado;
        }

        // Atualiza Data e Hora
        const agora = new Date();
        document.getElementById('data-hora-texto').innerText = 
            agora.toLocaleDateString('pt-BR') + " - " + 
            agora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

        // Efeito Confete
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#ff33cc', '#ffeb3b', '#2ecc71', '#4da3ff']
        });
    };
</script>
</body>
</html>